---
#
# create on specified server group -e server_group=dev
#

#
# execute on controller
#
- hosts: localhost
  connection: local

  tasks:
    - include_vars: config.yaml
    - include_vars: "{{ pmaker_home }}/state/{{ user_group }}/{{ server_group }}/users.yaml"

    - include: "{{ pmaker_home }}/lib/user_gen_key.yaml"
      when: (item.key is defined) and (item.key == true)
      with_items: "{{ users }}"

    - include: "{{ pmaker_home }}/lib/user_gen_password.yaml"
      when: (item.password is defined) and (item.password == true)
      with_items: "{{ users }}"

#
# execute on remote host
#
- hosts: all

  tasks:
    - include_vars: "config.yaml"
    - include_vars: "{{ pmaker_home }}/state/{{ user_group }}/{{ server_group }}/users.yaml"

    - include: "{{ pmaker_home }}/lib/user_create_stub.yaml"
      with_items: "{{ users }}"
      when: host_type is defined and (host_type == "jump")

    - include: "{{ pmaker_home }}/lib/user_create.yaml"
      with_items: "{{ users }}"
      when: host_type is defined and (host_type == "application" or host_type == "network"  or host_type == "util") 

    - include: "{{ pmaker_home }}/lib/user_set_key.yaml"
      when: (item.key is defined) and (item.key == true)
      with_items: "{{ users }}"

    - include: "{{ pmaker_home }}/lib/user_set_password.yaml"
      when: (item.password is defined) and (item.password == true)
      with_items: "{{ users }}"

    - include: "{{ pmaker_home }}/lib/user_sudoers.yaml"
      with_items: "{{ users }}"
      when: host_type is defined and (host_type == "application" or host_type == "network"  or host_type == "util") 


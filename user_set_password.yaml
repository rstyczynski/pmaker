---
- name: Check if password file exists i.e. password already generated
  become: yes
  stat: 
    path: "/home/{{ item.username }}/.ssh/secret.txt"
  register: password_created

- name: Encrypt Password (Linux)
  set_fact:
    encrypted_passwd: "{{ lookup('file', '/opt/pmaker/{{ server_group }}/{{ item.username }}/.ssh/secret.txt') | password_hash('sha512') }}"
  when:
    - ansible_system == "Linux"
    - password_created.stat.exists == False

- name: Update User Password
  become: yes
  user:
    name: '{{ item.username }}'
    password: "{{ encrypted_passwd }}"
  when: password_created.stat.exists == False

- name: Mark password creation
  become: yes
  copy: content={{ encrypted_passwd }} dest="/home/{{ item.username }}/.ssh/secret.txt"
  when: password_created.stat.exists == False
